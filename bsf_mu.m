% Estima el factor de retrodispersión y el cociente de poderes de frenado másico por interpolación cúbica en función de x = filtración de cobre mm y = kV y z = lado del campo cuadrado en superficie en cm.
function [bsf, u_en_ro] = bsf_mu(area_sup, y_kv_q, filtr1m, filtr1th, filtr2m, filtr2th)
% Interpola valores de bsf y razón de poderes de frenado según la
% referencia:
% Hamza Benmakhlouf1,2, Hugo Bouchard3, Annette Fransson1 and Pedro Andreo.
% Phys. Med. Biol. 56 (2011) 7179–7204 doi:10.1088/0031-9155/56/22/012
%
% Table 3. Backscatter factors Bair(Q) and water-to-air mass energy–absorption coefficient ratios, 
% (?en(Q)/?)w,air, at the entrance surface of a 15 cm thick water phantom for square
% clinical beams of sides between 5 and 35 cm used in modern diagnostic and interventional radiology. 
% The quality of the beams is specified in terms of kilovoltage, inherent and added
% filtration, first half-value layer, and homogeneity coefficient, h = HVL1/HVL2. 
% The estimated combined standard uncertainties are 1% and 2.5%, respectively, including Hubbell (1977)
% estimates for the energy-absorption coefficients (1%) and their ratios (2.5%).
%
x_tc = [5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 ...
    5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 ...
    5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 ...
    5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 ...
    5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 ...
    5 10 20 25 35 5 10 20 25 35 5 10 20 25 35 5 10 20 25 35]';
y_kv = [50 50 50 50 50 80 80 80 80 80 110 110 110 110 110 150 150 150 150 150 ...
    50 50 50 50 50 80 80 80 80 80 110 110 110 110 110 150 150 150 150 150 ...
    50 50 50 50 50 80 80 80 80 80 110 110 110 110 110 150 150 150 150 150 ...
    50 50 50 50 50 80 80 80 80 80 110 110 110 110 110 150 150 150 150 150 ...
    50 50 50 50 50 80 80 80 80 80 110 110 110 110 110 150 150 150 150 150 ...
    50 50 50 50 50 80 80 80 80 80 110 110 110 110 110 150 150 150 150 150]';
z_f = [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
    0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 ...
    0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 ...
    0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 ...
    0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 ...
    0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9]';
% 
v1_BSF = [1.204 1.257 1.282 1.285 1.287 1.242 1.331 1.39 1.4 1.408 1.254 1.363 1.446 1.463 1.476 1.253 1.373 1.473 1.495 1.514...
    1.244 1.32 1.36 1.366 1.368 1.275 1.392 1.476 1.492 1.504 1.275 1.408 1.515 1.538 1.557 1.262 1.398 1.517 1.544 1.568...
    1.264 1.354 1.405 1.412 1.416 1.289 1.421 1.522 1.541 1.556 1.281 1.425 1.546 1.573 1.595 1.261 1.404 1.532 1.561 1.589...
    1.275 1.376 1.434 1.443 1.448 1.295 1.438 1.55 1.572 1.589 1.282 1.432 1.562 1.591 1.616 1.258 1.404 1.537 1.568 1.597...
    1.293 1.411 1.485 1.496 1.503 1.3 1.458 1.589 1.617 1.639 1.277 1.435 1.578 1.611 1.64 1.247 1.394 1.534 1.567 1.6...
    1.301 1.428 1.511 1.524 1.532 1.299 1.463 1.604 1.635 1.66 1.271 1.43 1.578 1.613 1.645 1.237 1.381 1.523 1.557 1.592]';
v2_u_en_ro = [1.016 1.016 1.016 1.016 1.016 1.03 1.029 1.028 1.028 1.028 1.045 1.043 1.041 1.041 1.041 1.057 1.055 1.053 1.053 1.052...
    1.016 1.016 1.016 1.016 1.016 1.034 1.033 1.031 1.031 1.031 1.049 1.047 1.045 1.045 1.045 1.061 1.059 1.057 1.057 1.056...
    1.017 1.017 1.016 1.016 1.016 1.037 1.035 1.034 1.034 1.033 1.052 1.05 1.048 1.048 1.047 1.064 1.062 1.06 1.059 1.059...
    1.018 1.017 1.017 1.017 1.017 1.039 1.037 1.036 1.036 1.035 1.055 1.053 1.05 1.05 1.05 1.067 1.064 1.062 1.062 1.061...
    1.019 1.019 1.018 1.018 1.018 1.044 1.042 1.04 1.04 1.04 1.06 1.058 1.055 1.055 1.054 1.072 1.07 1.067 1.067 1.066...
    1.02 1.02 1.019 1.019 1.019 1.047 1.045 1.043 1.043 1.042 1.064 1.062 1.059 1.058 1.058 1.076 1.074 1.071 1.071 1.07]';
% Lado del campo cuadrado en superficie
x_tc_q = double(sqrt(area_sup));
% Extraemos la filtración de cobre de la info del RDSR
z_f_q = 0;
if (strcmp(filtr1m,'Copper or Copper compound') == 1 ||...
        strcmp(filtr2m,'Copper or Copper compound') == 1)
    if strcmp(filtr1m,'Copper or Copper compound') == 1
        z_f_q = filtr1th;
    else
        z_f_q = filtr2th;
    end
end

% Interpolants para evaluar función
F_BSF = scatteredInterpolant(x_tc, y_kv, z_f, v1_BSF, "natural", "nearest");
F_u = scatteredInterpolant(x_tc, y_kv, z_f, v2_u_en_ro, "natural", "nearest");
% Estimación de bsf y u_en_ro por interpolación
bsf = F_BSF(x_tc_q, y_kv_q, z_f_q);
u_en_ro = F_u(x_tc_q, y_kv_q, z_f_q);
end
